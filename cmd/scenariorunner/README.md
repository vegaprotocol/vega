# scenario-runner-cli

This document describes the `scenario-runner-cli` tool. It starts with a simple how-to guide showing how the tool can be used. The subsequent section lists the currently available instructions and their syntax. It finishes with a discussion of the current limitations of the tool and the planned modifications.

---
**NOTE**

When creating your own scenarios please add them to the `/cmd/scenariorunner/scenarios` folder - please feel free to create any subfolders you see fit. This should make it easier to collaborate on scenarios and investigate any possible bugs. It will also allow us introduce breaking changes to the tool as that way we can amend any scenarios that might get broken due to such a change. While we aim to assure forward compatibility, there might still be a need to introduce such changes at the early stages of the project.

---

## HOW-TO: Submit an instruction set

---
**NOTE**

If you haven't cloned `trading-core` locally yet you can do it by following the steps outlined in the [Getting Started](../../GETTING_STARTED.md) guide.

Throughout this document we will assume that your local folder containing the `trading-core` repository is named `vega`.

---

An instruction set contains a collection of instructions that can be submitted to the `scenario-runner-cli`. You can find an example of it in `vega/cmd/scenariorunner/scenarios/examples/exampleInstructions.json`.
The steps described below show how to submit an instruction set to the `scenario-runner-cli`.

### Setup

* Make sure you have `trading-core` clonned locally (see guide mentioned at the beginning of this section if that's not the case).
* Open a command line tool and navigate to the directory where you have cloned `trading-core`.
* Call:

    ```bash
    git checkout develop
    git pull
    ```

    to assure you're on the `develop` branch and you have the latest version of code.
* Call:

    ```bash
    make install
    ```

    to assure that the latest version of the `scenario-runner-cli` gets installed.
* Verify that it has installed successfully by calling:

    ```bash
    scenariorunner --help
    ```

### Empty instruction set

The instruction set doesn't need to contin any instructions for the tool to be able to process it. While this feature is of limited practical use, it is useful to go through an example involving it to make it easier to see how both the instruction set and the optional result file that can be output by the `scenario-runner-cli` are structured.

* Navigate to the `scneariorunner` subfolder (the only effect of this step is to shorten the paths used in calls to the `scenario-runner-cli`. The `scenariorunner` command can be called from any directory):

    ```bash
    cd cmd/scenariorunner
    ```

* Submit the instruction set by calling:

    ```bash
    scenariorunner submit scenarios/examples/empty.json --config configs/noMarkets.json --result example1Results.json
    ```

* The step above should result in creation of the `example1Results.json` file. More information of the structure of the instruction set and the result file can be found in the [instructions](#instructions) section below.

* The output file can be examined by calling:

    ```bash
    cat example1Results.json
    ```

Let's finish this subsection with the discussion of flags used in a call to the `submit` command specified above - note that a list of available subcommands can be obtained by calling:

```bash
scenariorunner submit --help
```

We used:

* `--config` to point the tool to a config file that we wanted to use when processing the instructions - more details in [config](#config) section. On this occassion we have used a config file that doesn't specify any markets to keep the result file light so that its' structure can be easily examined.
* `--result` to provide a directory for the result file to be saved in.

### Generating a trade

For a more involved example please execute

```bash
scenariorunner submit scenarios/examples/tradeGeneration.json --config configs/standard.json --result example2Results.json
```

This should generate the `example2Results.json` file. Examine the file to familiarize yourself with the structure of results generated by tool.

### Multiple instruction sets

Multiple instruction sets can be submitted at once. The state of the execution engine doesn't reset between sets when the `submit` command gets invoked with more than one set, hence scenarios can be broken down into multiple instruction sets. We ilustrate it with a simple example:

```bash
scenariorunner submit scenarios/examples/empty.json scenarios/examples/tradeGeneration.json --config configs/standard.json --result example3Result.json
```

The above command should create 2 result files: "example3Result_1of2.json" & "example3Result_2of2.json", which contain results for the "empty.json" & "tradeGeneration.json" instruction sets specified in the above call.

## Inputs and outputs

Currently the tool supports only the JSON format for its' inputs, outputs and the config file. The section discusses the structure and syntax of those files.

### Instruction set

Instruction set holds a list of instructions that the `scenario-runner-cli` tool processes sequentially and an optional description field.

```json

{
  "description": "An example instruction set, instructions get listed between the two square brackets - '[]' - and get separated by commas",
  "instructions": []
}

```

It gets submitted to the tool by invoking the "submit" command and providing a path to it - see the how-to guide in the preceding section for more details.

### Instructions

This subsection discusses the available `scenario-runner-cli` instructions and their syntax.

Each instruction has the following fields:

* **description** - holds a description for an instruction. It doesn't affect the outcome of an instruction in any way, it's just an optional field that can be used for commenting or reference as it gets printed in the results.
* **request** - specifies the instruction type to be executed
* **message** - holds the parameters needed for the specified request

Below is an example of an instruction with all of those fields populated:

```json
{
    "description": "Set the time to 8am, 2 January 2019",
    "request": "SET_TIME",
    "message": {
        "@type": "core.SetTimeRequest",
        "time": "2019-01-02T08:00:00Z"
    }
}

```

The reminder of this subsection lists all the available requests along with their message types and fields.

* SET_TIME

    Sets the time within the execution engine. Please note this can also be specified in a config file and doesn't need to be called explicitly as an instruction.

```json
{
    "request": "SET_TIME",
    "message": {
        "@type": "core.SetTimeRequest",
        "time": "2019-01-02T08:00:00Z"
    }
}

```

* **ADVANCE_TIME**

    Advances the time within the execution engine by a specified amount. Please note config file has options to automatically advance time after each instruction.

```json

{
    "request": "ADVANCE_TIME",
    "message": {
    "@type": "core.AdvanceTimeRequest",
    "timeDelta": "0.1s"
    }
}

```

* **NOTIFY_TRADER_ACCOUNT**

    Creates an account for a specified trader and adds funds to it.

```json

{
    "request": "NOTIFY_TRADER_ACCOUNT",
    "message": {
    "@type": "api.NotifyTraderAccountRequest",
    "notif": {
        "traderID": "trader1",
        "amount": 1000
        }
    }
}

```

* **SUBMIT_ORDER**

    Submits an order to the execution enginge. Market IDs are specified in the config file. The expiry time needs to be specified as the Unix time, see the [time package](https://golang.org/pkg/time/#Time.UnixNano) documentation for details.

```json

{
    "request": "SUBMIT_ORDER",
    "message": {
    "@type": "api.SubmitOrderRequest",
    "submission": {
        "marketID": "JXGQYDVQAP5DJUAQBCB4PACVJPFJR4XI",
        "partyID": "trader1",
        "price": 100,
        "size": 3,
        "side": "Sell",
        "TimeInForce": "GTC",
        "expiresAt": 1924991999000000000
        }
    }
}

```

* **CANCEL_ORDER**

    Cancels an order - please note it's not currently possible to submit a successful order cancellation request.

```json
{
    "request": "CANCEL_ORDER",
    "message": {
    "@type": "api.CancelOrderRequest",
    "cancellation": {
        "orderID": "order1",
        "marketID": "JXGQYDVQAP5DJUAQBCB4PACVJPFJR4XI",
        "partyID": "trader1"
        }
    }
}

```

* **AMEND_ORDER**

    Amends an order - please note it's not currently possible to submit a successful order amendment request.

```json

"request": "AMEND_ORDER",
"message": {
    "@type": "api.AmendOrderRequest",
    "amendment": {
        "orderID": "order1",
        "marketID": "JXGQYDVQAP5DJUAQBCB4PACVJPFJR4XI",
        "partyID": "trader1",
        "price": 100,
        "size": 3,
        "side": "Buy",
        "expiresAt": 1924991999000000000
        }
    }

```

* **WITHDRAW**

    Withdraws a specified amount from party's account.

```json

{
    "request": "WITHDRAW",
    "message": {
    "@type": "api.WithdrawRequest",
    "withdraw": {
        "partyID": "trader1",
        "amount": 10,
        "asset": "BTC"
        }
    }
}

```

* **MARKET_SUMMARY**

    Provides a summary for the specified market.

```json

{
    "request": "MARKET_SUMMARY",
    "message": {
    "@type": "core.MarketSummaryRequest",
    "marketID": "JXGQYDVQAP5DJUAQBCB4PACVJPFJR4XI"
    }
}

```

* **SUMMARY**

    Provides a summary for all markets and parties

```json

{
    "request": "SUMMARY",
    "message": {
    "@type": "core.SummaryRequest"
    }
}

```

### Results

When invoking the `submit` command with the `--result` flag along with the output file name an output file gets generated per each instruction set specified. It contain the following elements:

* **Metadata**

    Specifies the number of instructions that were processed and omitted, number of trades generated and the time it took to process a given instruction set.

* **Results**

    Displays an array of results. Each result displays the instruction that was submitted, an error (if it occurred) and a request received (unless an error occurred) - please note some instructions result in empty resposes - it is an expected behavior.

* **Initial state**

    Displays the summary of all markets and parties prior to processing any instructions from a current set.

* **Final state**

    Displays the summary of all markets and parties after all instructions from a current set have been processed.

* **Config**

    Displays the configuration used during the execution of a given instruction set.

* **Version**

    Displays information on the version used for the processing of the specified instruction set.

## Config

Config file can be specified with the additional `--config` flag during a call to `submit`. It is optional and a default config will be used if it's skipped, however it's recommended to specify it explicitly.

The config is a JSON file with a structure outlined below:

```json

{
  "initialTime": "2019-01-02T08:00:00Z",
  "advanceTimeAfterInstruction": true,
  "timeDelta": "0.000000001s",
  "omitUnsupportedInstructions": true,
  "omitInvalidInstructions": true,
  "markets": [
    {
      "id": "JXGQYDVQAP5DJUAQBCB4PACVJPFJR4XI",
      "name": "ETHBTC/DEC19",
      "tradableInstrument": {
        "instrument": {
          "id": "Crypto/ETHBTC/Futures/Dec19",
          "code": "CRYPTO:ETHBTC/DEC19",
          "name": "December 2019 ETH vs BTC future",
          "baseName": "ETH",
          "quoteName": "BTC",
          "metadata": {
            "tags": ["asset_class:fx/crypto", "product:futures"]
          },
          "initialMarkPrice": "5",
          "future": {
            "maturity": "2019-12-31T23:59:59Z",
            "asset": "BTC",
            "ethereumEvent": {
              "contractID": "0x0B484706fdAF3A4F24b2266446B1cb6d648E3cC1",
              "event": "price_changed"
            }
          }
        },
        "marginCalculator": {
          "scalingFactors": {
            "searchLevel": 1.1,
            "initialMargin": 1.2,
            "collateralRelease": 1.4
          }
        },
        "forwardRiskModel": {
          "riskAversionParameter": 0.01,
          "tau": 0.00011407711613050422,
          "params": {
            "mu": 0,
            "r": 0.016,
            "sigma": 0.09
          }
        }
      },
      "decimalPlaces": "5",
      "continuous": {}
    }
  ]
}

```

A standard config file can be found in [`cmd/scenariorunner/configs/standard.json`](cmd/scenariorunner/configs/standard.json)

## Current limitations

### State

Currently the tool doesn't hold or track any state which makes it impossible to use results of preceding instructions in new instructions (e.g. cancel/amend order). It also prevents a more complex analysis of impact of particular instructions on the state of the protocol.

### Assertions

Currently the tool doesn't support built-in assertions which prevents encoding and automated checking of expected vs actual results. The results can only be manually revivewed or run via unit tests with assertions specified there.

### Decoupling

Currently the available instructions and their syntax are closely coupled with the public API types exposed by the `trading-core`.

This document will get updated with a proposed API for the scenario runner.

As the project matures the plan is to move it to a separate repository.
