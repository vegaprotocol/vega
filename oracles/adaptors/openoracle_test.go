package adaptors_test

import (
	"encoding/hex"
	"encoding/json"
	"testing"

	"code.vegaprotocol.io/vega/crypto"
	"code.vegaprotocol.io/vega/oracles"
	"code.vegaprotocol.io/vega/oracles/adaptors"

	"code.vegaprotocol.io/oracles-relay/openoracle"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

func TestOpenOracleAdaptor(t *testing.T) {
	t.Run("Normalising incompatible data fails", testOpenOracleAdaptorNormalisingIncompatibleDataFails)
	t.Run("Normalising compatible but invalid data fails", testOpenOracleAdaptorNormalisingCompatibleButInvalidDataFails)
	t.Run("Normalising compatible and valid data succeeds", testOpenOracleAdaptorNormalisingCompatibleAndValidDataSucceeds)
}

func testOpenOracleAdaptorNormalisingIncompatibleDataFails(t *testing.T) {
	// given
	pubKeyB := []byte("0xdeadbeef")
	pubKey := crypto.NewPublicKeyOrAddress(hex.EncodeToString(pubKeyB), pubKeyB)
	rawData, _ := json.Marshal(struct {
		Prices       string
		MarketNumber uint
	}{
		Prices:       "42",
		MarketNumber: 1337,
	})

	// when
	normalisedData, err := adaptors.NewOpenOracleAdaptor().Normalise(pubKey, rawData)

	// then
	assert.Error(t, err)
	assert.Nil(t, normalisedData)
}

func testOpenOracleAdaptorNormalisingCompatibleButInvalidDataFails(t *testing.T) {
	// given
	pubKeyB := []byte("0xdeadbeef")
	pubKey := crypto.NewPublicKeyOrAddress(hex.EncodeToString(pubKeyB), pubKeyB)
	rawData, _ := json.Marshal(openoracle.OracleResponse{
		Timestamp: "1611924180",
		Messages: []string{
			"0x000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000601402d400000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000008b38744c80000000000000000000000000000000000000000000000000000000000000006707269636573000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000034254430000000000000000000000000000000000000000000000000000000000",
			"0x000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000601402d400000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000005433a2300000000000000000000000000000000000000000000000000000000000000006707269636573000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000034554480000000000000000000000000000000000000000000000000000000000",
			"0x000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000601402d400000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000002d1ff400000000000000000000000000000000000000000000000000000000000000067072696365730000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000358545a0000000000000000000000000000000000000000000000000000000000",
			"0x000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000601401e400000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000f4b2e0000000000000000000000000000000000000000000000000000000000000006707269636573000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000034441490000000000000000000000000000000000000000000000000000000000",
			"0x000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000601401a800000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000013461500000000000000000000000000000000000000000000000000000000000000006707269636573000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000035245500000000000000000000000000000000000000000000000000000000000",
			"0x0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000006014029800000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000009185b0000000000000000000000000000000000000000000000000000000000000006707269636573000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000035a52580000000000000000000000000000000000000000000000000000000000",
			"0x0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000006014029800000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000004c3330000000000000000000000000000000000000000000000000000000000000006707269636573000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000034241540000000000000000000000000000000000000000000000000000000000",
			"0x0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000006014025c00000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000013acb80000000000000000000000000000000000000000000000000000000000000006707269636573000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000034b4e430000000000000000000000000000000000000000000000000000000000",
			"0x0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000006014029800000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000016826340000000000000000000000000000000000000000000000000000000000000006707269636573000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044c494e4b00000000000000000000000000000000000000000000000000000000",
			"0x000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000601402d400000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000edfada0000000000000000000000000000000000000000000000000000000000000000670726963657300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004434f4d5000000000000000000000000000000000000000000000000000000000",
			"0x000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000601402d400000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000df2c6c000000000000000000000000000000000000000000000000000000000000000670726963657300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003554e490000000000000000000000000000000000000000000000000000000000",
			"0x000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000601402d400000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000865ce0000000000000000000000000000000000000000000000000000000000000006707269636573000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000034752540000000000000000000000000000000000000000000000000000000000",
		},
		Signatures: []string{ // Broken signatures
			"0x007c80118c4e9c871a2342f5ee6e182d1aa8a463c7487b9292d728fc867c188b65838a1a721cc80795b93d40635525f1714d2f272b198be6f379d36617ed1966000000000000000000000000000000000000000000000000000000000000001b",
			"0x00f40ce29496af004c77b780032b28715a38454d610e9641f0c7aca5bfd494c5cabdbb70340cdf9d0145b9ca8ba3627688013c5999ff9b00690c76ab4102c8d3000000000000000000000000000000000000000000000000000000000000001c",
			"0x008aaa6bc4c04e0039c5531119c68e5f74b8e78aba57397c2f3c7b74787202faa73b7fb0817924ec0bdb9b8761bf2c94be0249160a4b99bc25a39a8431271763000000000000000000000000000000000000000000000000000000000000001c",
			"0x0085ec34b36eef7000a878c147328872168b7fdb1a822256857cf5e015cb9b9a23ec5bbcdaf9e18edd6b6c088f8e4e56bcb74f7f8b2ad990883b51642438cd64000000000000000000000000000000000000000000000000000000000000001c",
			"0x005e8a60b777296f9fed37df5af51d13e1303882bb03b084d548ca77e0aba842de1d5beafecdaf3dada91da21e3478164aadaf489d9d3223f50cd92cab778f6c000000000000000000000000000000000000000000000000000000000000001b",
			"0x00cf582b040ed849d09813aa7bf7f6b68ab53a3c459987f5a846d984aaacd11fa7ace4dc1b1dc6b338c1d9a25bd20829f431e4571a0889bba878a40fb78d7b80000000000000000000000000000000000000000000000000000000000000001b",
			"0x0039118be2546aa6493fa5a5eb4477d098aef0537db83b520781592bd01c7606ef390d0e332277b1ed55acf0ef8922e2feddf05c79d780dbc25431495ecd85ad000000000000000000000000000000000000000000000000000000000000001b",
			"0x00f90e238defaf70ae8e8cc0fe9aae7f27dc8b3624c2ef023f66e7a6de90f6c4b22f9f603d7d049d17f605827fd1bf08d4f1fa7778a81bbe447c4c20b82cc274000000000000000000000000000000000000000000000000000000000000001b",
			"0x004e0c8ac16591bf5cb57cb96536910384b5cd7a3ee478f968fa179947e595e8d6137a1d8d38815df25b6a8b96055e896b1293b19c0cf9f06cd03fc78630576e000000000000000000000000000000000000000000000000000000000000001c",
			"0x00245a1b11e3742fda4b8d1611b636625e10a2749e691d717aa75f30970a85c1d8d72541bf664fea528c50d444665db6071bae4c4013f97d30556f6bc4f521c7000000000000000000000000000000000000000000000000000000000000001c",
			"0x008b8d87bafc2ba13ac1e51a12353e66fc08a8aadd2741465cdffa97727d0143b2bbc324b16242e0138b523b29329fe9390efa2fdd360a3617742dc3eb02c461000000000000000000000000000000000000000000000000000000000000001b",
			"0x00d0e50d507e7caca0ec3185d7bc55583f62faa7c614d65e244d577184ce1e3a6e00c7290af35116792f35a61a3cf9baa4dc381c90df1d57dae64e6ac0993aa4000000000000000000000000000000000000000000000000000000000000001b",
		},
		Prices: map[string]string{
			"BTC":  "37371.725",
			"ETH":  "1412.67",
			"XTZ":  "2.9573",
			"DAI":  "1.0022864999999999",
			"REP":  "20.21",
			"ZRX":  "0.5960595",
			"BAT":  "0.312115",
			"KNC":  "1.2894",
			"LINK": "23.60274",
			"COMP": "249.54",
			"UNI":  "14.625900000000001",
			"GRT":  "0.55035",
		},
	})

	// when
	normalisedData, err := adaptors.NewOpenOracleAdaptor().Normalise(pubKey, rawData)

	// then
	assert.Error(t, err)
	assert.Nil(t, normalisedData)
}

func testOpenOracleAdaptorNormalisingCompatibleAndValidDataSucceeds(t *testing.T) {
	// given
	pubKeyB := []byte("0xdeadbeef")
	pubKey := crypto.NewPublicKeyOrAddress(hex.EncodeToString(pubKeyB), pubKeyB)
	rawData, _ := json.Marshal(openoracle.OracleResponse{
		Timestamp: "1611924180",
		Messages: []string{
			"0x000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000601402d400000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000008b38744c80000000000000000000000000000000000000000000000000000000000000006707269636573000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000034254430000000000000000000000000000000000000000000000000000000000",
			"0x000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000601402d400000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000005433a2300000000000000000000000000000000000000000000000000000000000000006707269636573000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000034554480000000000000000000000000000000000000000000000000000000000",
			"0x000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000601402d400000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000002d1ff400000000000000000000000000000000000000000000000000000000000000067072696365730000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000358545a0000000000000000000000000000000000000000000000000000000000",
			"0x000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000601401e400000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000f4b2e0000000000000000000000000000000000000000000000000000000000000006707269636573000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000034441490000000000000000000000000000000000000000000000000000000000",
			"0x000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000601401a800000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000013461500000000000000000000000000000000000000000000000000000000000000006707269636573000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000035245500000000000000000000000000000000000000000000000000000000000",
			"0x0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000006014029800000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000009185b0000000000000000000000000000000000000000000000000000000000000006707269636573000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000035a52580000000000000000000000000000000000000000000000000000000000",
			"0x0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000006014029800000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000004c3330000000000000000000000000000000000000000000000000000000000000006707269636573000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000034241540000000000000000000000000000000000000000000000000000000000",
			"0x0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000006014025c00000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000013acb80000000000000000000000000000000000000000000000000000000000000006707269636573000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000034b4e430000000000000000000000000000000000000000000000000000000000",
			"0x0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000006014029800000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000016826340000000000000000000000000000000000000000000000000000000000000006707269636573000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044c494e4b00000000000000000000000000000000000000000000000000000000",
			"0x000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000601402d400000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000edfada0000000000000000000000000000000000000000000000000000000000000000670726963657300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004434f4d5000000000000000000000000000000000000000000000000000000000",
			"0x000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000601402d400000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000df2c6c000000000000000000000000000000000000000000000000000000000000000670726963657300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003554e490000000000000000000000000000000000000000000000000000000000",
			"0x000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000601402d400000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000865ce0000000000000000000000000000000000000000000000000000000000000006707269636573000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000034752540000000000000000000000000000000000000000000000000000000000",
		},
		Signatures: []string{
			"0x137c80118c4e9c871a2342f5ee6e182d1aa8a463c7487b9292d728fc867c188b65838a1a721cc80795b93d40635525f1714d2f272b198be6f379d36617ed1966000000000000000000000000000000000000000000000000000000000000001b",
			"0x7af40ce29496af004c77b780032b28715a38454d610e9641f0c7aca5bfd494c5cabdbb70340cdf9d0145b9ca8ba3627688013c5999ff9b00690c76ab4102c8d3000000000000000000000000000000000000000000000000000000000000001c",
			"0x1f8aaa6bc4c04e0039c5531119c68e5f74b8e78aba57397c2f3c7b74787202faa73b7fb0817924ec0bdb9b8761bf2c94be0249160a4b99bc25a39a8431271763000000000000000000000000000000000000000000000000000000000000001c",
			"0x4c85ec34b36eef7000a878c147328872168b7fdb1a822256857cf5e015cb9b9a23ec5bbcdaf9e18edd6b6c088f8e4e56bcb74f7f8b2ad990883b51642438cd64000000000000000000000000000000000000000000000000000000000000001c",
			"0x275e8a60b777296f9fed37df5af51d13e1303882bb03b084d548ca77e0aba842de1d5beafecdaf3dada91da21e3478164aadaf489d9d3223f50cd92cab778f6c000000000000000000000000000000000000000000000000000000000000001b",
			"0x60cf582b040ed849d09813aa7bf7f6b68ab53a3c459987f5a846d984aaacd11fa7ace4dc1b1dc6b338c1d9a25bd20829f431e4571a0889bba878a40fb78d7b80000000000000000000000000000000000000000000000000000000000000001b",
			"0x4c39118be2546aa6493fa5a5eb4477d098aef0537db83b520781592bd01c7606ef390d0e332277b1ed55acf0ef8922e2feddf05c79d780dbc25431495ecd85ad000000000000000000000000000000000000000000000000000000000000001b",
			"0x82f90e238defaf70ae8e8cc0fe9aae7f27dc8b3624c2ef023f66e7a6de90f6c4b22f9f603d7d049d17f605827fd1bf08d4f1fa7778a81bbe447c4c20b82cc274000000000000000000000000000000000000000000000000000000000000001b",
			"0xc14e0c8ac16591bf5cb57cb96536910384b5cd7a3ee478f968fa179947e595e8d6137a1d8d38815df25b6a8b96055e896b1293b19c0cf9f06cd03fc78630576e000000000000000000000000000000000000000000000000000000000000001c",
			"0x74245a1b11e3742fda4b8d1611b636625e10a2749e691d717aa75f30970a85c1d8d72541bf664fea528c50d444665db6071bae4c4013f97d30556f6bc4f521c7000000000000000000000000000000000000000000000000000000000000001c",
			"0x288b8d87bafc2ba13ac1e51a12353e66fc08a8aadd2741465cdffa97727d0143b2bbc324b16242e0138b523b29329fe9390efa2fdd360a3617742dc3eb02c461000000000000000000000000000000000000000000000000000000000000001b",
			"0x9dd0e50d507e7caca0ec3185d7bc55583f62faa7c614d65e244d577184ce1e3a6e00c7290af35116792f35a61a3cf9baa4dc381c90df1d57dae64e6ac0993aa4000000000000000000000000000000000000000000000000000000000000001b",
		},
		Prices: map[string]string{
			"BTC":  "37371.725",
			"ETH":  "1412.67",
			"XTZ":  "2.9573",
			"DAI":  "1.0022864999999999",
			"REP":  "20.21",
			"ZRX":  "0.5960595",
			"BAT":  "0.312115",
			"KNC":  "1.2894",
			"LINK": "23.60274",
			"COMP": "249.54",
			"UNI":  "14.625900000000001",
			"GRT":  "0.55035",
		},
	})

	// when
	normalisedData, err := adaptors.NewOpenOracleAdaptor().Normalise(pubKey, rawData)

	// then
	expectedData := oracles.OracleData{
		Data: map[string]string{
			"prices.BTC.value":      "37371725000",
			"prices.BTC.timestamp":  "1611924180",
			"prices.ETH.value":      "1412670000",
			"prices.ETH.timestamp":  "1611924180",
			"prices.XTZ.value":      "2957300",
			"prices.XTZ.timestamp":  "1611924180",
			"prices.DAI.value":      "1002286",
			"prices.DAI.timestamp":  "1611923940",
			"prices.REP.value":      "20210000",
			"prices.REP.timestamp":  "1611923880",
			"prices.ZRX.value":      "596059",
			"prices.ZRX.timestamp":  "1611924120",
			"prices.BAT.value":      "312115",
			"prices.BAT.timestamp":  "1611924120",
			"prices.KNC.value":      "1289400",
			"prices.KNC.timestamp":  "1611924060",
			"prices.LINK.value":     "23602740",
			"prices.LINK.timestamp": "1611924120",
			"prices.COMP.value":     "249540000",
			"prices.COMP.timestamp": "1611924180",
			"prices.UNI.value":      "14625900",
			"prices.UNI.timestamp":  "1611924180",
			"prices.GRT.value":      "550350",
			"prices.GRT.timestamp":  "1611924180",
		},
		PubKeys: []string{"0xfCEAdAFab14d46e20144F48824d0C09B1a03F2BC"},
	}

	require.NoError(t, err)
	assert.Equal(t, &expectedData, normalisedData)
}
