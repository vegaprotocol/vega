---
image: golang:1.11.5

variables:
  CGO_ENABLED: "0"
  GO111MODULE: "on"
  GOOS: linux
  GOARCH: amd64
  GOPATH: "${CI_PROJECT_DIR}/go" # Can only cache files inside ${CI_PROJECT_DIR}
  # There's no recursive expansion of vars.
  BIN_DIR: "${CI_PROJECT_DIR}/go/bin"
  SRC_DIR: "${CI_PROJECT_DIR}/go/src"
  PKGMOD_DIR: "${CI_PROJECT_DIR}/go/pkg/mod"
  VEGA_TEST_DATADIR: "${CI_PROJECT_DIR}/testdata"

cache:
  key: ${CI_COMMIT_REF_SLUG} # one cache per branch
  paths:
    - ${PKGMOD_DIR}

stages:
  - deps
  - test
  - build
  - deploy

before_script:
  - mkdir -p "${BIN_DIR}" "${PKGMOD_DIR}" "${SRC_DIR}"
  - find -maxdepth 1 -not -name . -and -not -name go -exec mv '{}' "${SRC_DIR}/" ';'
  - cd "${SRC_DIR}"

deps:
  stage: deps
  script:
    - make deps

unit_tests:
  stage: test
  script:
    - make test

#race_detector:
#  stage: test
#  script:
#    - make race

# FUTURE:
# Requires custom GCC based docker image
#
# memory_sanitizer:
#  stage: test
#  script:
#    - make msan

code_coverage:
  stage: test
  script:
    - make coveragehtml
  only:
    - /^(master|develop)$/

#lint_code:
#  stage: test
#  script:
#    - make lint

build_vega:
  stage: build
  script:
    - make install
  artifacts:
    paths:
      - ${BIN_DIR}
    expire_in: 2 weeks
